#!/bin/bash

# Initialize environment

if [ -e "@TOP_DIR@/@CONFFILE@.sh" ]; then
    source "@TOP_DIR@/@CONFFILE@.sh"
fi

# Add install prefix to our environment.

mkdir -p @PYTHON_PREFIX@/bin
mkdir -p @PYTHON_PREFIX@/lib
mkdir -p @AUX_PREFIX@/lib/python@PYVERSION@/site-packages
pushd @AUX_PREFIX@ > /dev/null
if [ ! -e lib64 ]; then
    ln -s lib lib64
fi
popd > /dev/null

export CMBENV_AUX_ROOT=@AUX_PREFIX@
export CMAKE_PREFIX_PATH=@AUX_PREFIX@:${CMAKE_PREFIX_PATH}
export PATH=@AUX_PREFIX@/bin:@PYTHON_PREFIX@/bin:${PATH}
export CPATH=@AUX_PREFIX@/include:${CPATH}
export LIBRARY_PATH=@AUX_PREFIX@/lib:${LIBRARY_PATH}
export LD_LIBRARY_PATH=@AUX_PREFIX@/lib:${LD_LIBRARY_PATH}
export PYTHONPATH=@AUX_PREFIX@/lib/python@PYVERSION@/site-packages:${PYTHONPATH}

# Install packages

@PACKAGES@

# Compile python modules

python3 -m compileall -f "@AUX_PREFIX@"

# Set permissions

if [ "x@CHGRP@" != "x" ]; then
    chgrp -R @CHGRP@ "@AUX_PREFIX@"
    chgrp -R @CHGRP@ "@PYTHON_PREFIX@"
fi

if [ "x@CHMOD@" != "x" ]; then
    chmod -R @CHMOD@ "@AUX_PREFIX@"
    chmod -R @CHMOD@ "@PYTHON_PREFIX@"
fi

# Install modulefile

if [ "x@MODULE_DIR@" != "x" ]; then
    mkdir -p "@MODULE_DIR@"
    cp "$0.mod" "@MODULE_DIR@/@VERSION@"
    cp "$0.modver" "@MODULE_DIR@/.version_@VERSION@"

    if [ "x@CHGRP@" != "x" ]; then
        chgrp -R @CHGRP@ "@MODULE_DIR@"
    fi
    if [ "x@CHMOD@" != "x" ]; then
        chmod -R @CHMOD@ "@MODULE_DIR@"
    fi
fi
